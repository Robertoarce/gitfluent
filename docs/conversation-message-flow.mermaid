flowchart TD
    A["ğŸ‘¤ User Types Message"] --> B["ğŸ“¨ sendMessage(text)"]
    B --> C{{"ğŸ” Valid Message?<br/>(not empty & model ready)"}}
    
    C -->|"âŒ No"| D["ğŸš« Return Early"]
    C -->|"âœ… Yes"| E["ğŸ’¬ Create User Message<br/>with unique ID"]
    
    E --> F["ğŸ“± Add to UI Messages"]
    F --> G["ğŸ“š Add to Chat History<br/>as HumanChatMessage"]
    G --> H["ğŸ”„ Set isLoading = true"]
    H --> I["ğŸ”” notifyListeners()"]
    
    I --> J["ğŸ¤– Gemini API Call<br/>generateContent(chatHistory)"]
    J --> K{{"ğŸ“¡ API Response?"}}
    
    K -->|"ğŸ’¥ Error"| L["âš ï¸ Catch Exception"]
    K -->|"âœ… Success"| M["ğŸ“¨ Get Raw Response Text"]
    
    L --> N["ğŸ“ Log Error Message"]
    N --> O["ğŸ’¬ Add Error to UI"]
    O --> P["ğŸ”„ Set isLoading = false"]
    
    M --> Q{{"ğŸ” Response Empty?"}}
    Q -->|"âœ… Has Content"| R["ğŸ¯ Try JSON Parsing"]
    Q -->|"âŒ Empty"| S["ğŸ’¬ Default Sorry Message"]
    
    R --> T{{"ğŸ“‹ Valid JSON?"}}
    T -->|"âœ… Parsed"| U["ğŸ“Š Create ConversationResponse"]
    T -->|"âŒ Failed"| V["ğŸ“ Log Parse Error"]
    
    U --> W["ğŸ¨ Format Rich Response<br/>â€¢ Bot: [response]<br/>â€¢ Translation: [translation]<br/>â€¢ New Vocab: [words]<br/>â€¢ Corrections: [fixes]<br/>â€¢ Next: [question]"]
    
    V --> X["ğŸ“„ Use Raw Response Text"]
    S --> X
    
    W --> Y["ğŸ’¬ Create Bot Message<br/>with formatted text"]
    X --> Y
    
    Y --> Z["ğŸ“± Add Bot Message to UI"]
    Z --> AA["ğŸ“š Add to Chat History<br/>as AIChatMessage"]
    AA --> BB["ğŸ”„ Set isLoading = false"]
    BB --> CC["ğŸ”” notifyListeners()"]
    CC --> DD["âœ… Ready for Next Input"]
    
    P --> CC
    
    DD --> A
    
    style A fill:#e3f2fd
    style J fill:#fce4ec
    style U fill:#f3e5f5
    style W fill:#e8f5e8
    style Y fill:#fff3e0
    style DD fill:#c8e6c9 