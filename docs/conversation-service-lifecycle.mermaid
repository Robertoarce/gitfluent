flowchart TD
    A["ğŸš€ ConversationService<br/>Constructor"] --> B["ğŸ“‹ _initialize()"]
    B --> C["âš™ï¸ _loadConfigAndInitializeModel()"]
    B --> D["ğŸŒ _addInitialBotMessage()"]
    
    C --> E["ğŸ”„ Wait for GlobalSettingsService<br/>globalSettings.isInitialized"]
    E --> F["ğŸŒ Access GlobalSettingsService<br/>globalSettings.conversation"]
    F --> G["ğŸ”‘ Check GEMINI_API_KEY"]
    
    G -->|"âŒ No API Key"| H["âš ï¸ Add Error Message"]
    G -->|"âœ… API Key Found"| I["ğŸ¯ Get System Prompt Type<br/>globalSettings.conversation.systemPromptType"]
    
    I --> J["ğŸ‘¤ Get Language Settings<br/>_settings.languageSettings"]
    J --> K["ğŸŒ Build Language Variables<br/>target_language, native_language, etc."]
    K --> L["ğŸ“ Prompts.getPrompt()<br/>with language variables"]
    L --> M["ğŸ¤– Create Gemini Model<br/>globalSettings.conversation.model"]
    
    M --> N["ğŸ“š Initialize Chat History<br/>with System Message"]
    N --> O["âœ… Service Ready"]
    
    D --> P["ğŸ‘¤ Get Language Settings<br/>_settings.languageSettings"]
    P --> Q["ğŸŒ Get Target Language Code<br/>languageSettings?.targetLanguage?.code"]
    Q --> R["ğŸ“ Get Localized Message<br/>Prompts.getInitialBotMessage(targetLanguage)"]
    R --> S["ğŸ¯ Select Language-Specific Greeting<br/>â€¢ 'en': 'Hello! I'm your conversation partner...'<br/>â€¢ 'es': 'Â¡Hola! Soy tu compaÃ±ero...'<br/>â€¢ 'fr': 'Bonjour ! Je suis votre partenaire...'<br/>â€¢ 'it': 'Ciao! Sono il tuo partner...'<br/>â€¢ etc. (18 languages total)"]
    S --> T["ğŸ’¬ Add Localized Initial Message to UI"]
    
    O --> U["ğŸ‘¤ User Sends Message"]
    U --> V["ğŸ“¨ sendMessage(text)"]
    V --> W["â• Add User Message to UI"]
    W --> X["ğŸ“ Add to Chat History"]
    X --> Y["ğŸ”„ Set Loading State"]
    
    Y --> Z["ğŸ¤– Call Gemini API<br/>generateContent()"]
    Z --> AA["ğŸ“¨ Receive Raw Response"]
    AA --> BB["ğŸ” Try Parse JSON Response"]
    
    BB -->|"âœ… Valid JSON"| CC["ğŸ“‹ Parse ConversationResponse"]
    BB -->|"âŒ Invalid JSON"| DD["âš ï¸ Use Raw Text"]
    
    CC --> EE["ğŸ¨ Format Display Response<br/>â€¢ Bot Response<br/>â€¢ Translation<br/>â€¢ New Vocabulary<br/>â€¢ Corrections<br/>â€¢ Follow-up Question"]
    DD --> FF["ğŸ“„ Use Raw Response Text"]
    
    EE --> GG["ğŸ’¬ Add Bot Message to UI"]
    FF --> GG
    GG --> HH["ğŸ“š Add AI Message to History"]
    HH --> II["ğŸ”„ Clear Loading State"]
    II --> JJ["âœ… Ready for Next Message"]
    
    JJ --> U
    
    Z -->|"ğŸ’¥ API Error"| KK["âš ï¸ Handle Error"]
    KK --> LL["ğŸ“ Log Error"]
    LL --> MM["ğŸ’¬ Add Error Message"]
    MM --> II
    
    NN["ğŸ—‘ï¸ clearChat()"] --> OO["ğŸ“ Clear Messages & History"]
    OO --> PP["ğŸ”„ Re-initialize with Current Settings"]
    PP --> QQ["ğŸ‘¤ Get Current Language Settings"]
    QQ --> RR["ğŸŒ Get Updated Target Language"]
    RR --> SS["ğŸ’¬ Add New Localized Initial Message"]
    SS --> TT["ğŸ“š Recreate System Message<br/>with current globalSettings.languageVariables"]
    TT --> JJ
    
    UU["âš™ï¸ Settings Change Event<br/>(Language Updated)"] --> VV["ğŸ”„ Update Service State"]
    VV --> WW["ğŸŒ Reload Language Variables"]
    WW --> XX["ğŸ“ Update System Prompt"]
    XX --> YY["ğŸ’¬ Update Initial Message Language"]
    YY --> JJ
    
    ZZ["ğŸ” User Login/Logout Event"] --> AAA["ğŸ‘¤ UserPreferencesService Update"]
    AAA --> BBB["ğŸ”„ Language Settings Sync"]
    BBB --> CCC["ğŸŒ Update Target Language"]
    CCC --> VV
    
    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style U fill:#fff3e0
    style Z fill:#fce4ec
    style CC fill:#f3e5f5
    style EE fill:#e8f5e8
    style S fill:#ffe0b2
    style T fill:#c8e6c9
    style UU fill:#f8bbd9
    style ZZ fill:#d1c4e9